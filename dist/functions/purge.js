// Generated by CoffeeScript 2.5.1
//! ========================================
//! Purge
var handler;

handler = function(msg, match, Haruka) {
  var allowed, amount, args, ref, ref1;
  args = match.input.tokenize()[1];
  // First, check if the user can even delete messages
  allowed = (ref = msg.member) != null ? (ref1 = ref.permissionsIn(msg.channel)) != null ? ref1.has("MANAGE_MESSAGES") : void 0 : void 0;
  if (!allowed) {
    return msg.channel.send([`You don’t have permission to manage messages in this channel, ${msg.author}.`, `${msg.author}, You can’t do that, you don’t have permissions to do so.`, `Sorry ${msg.author}, but you’re not allowed to delete messages.`].choose());
  }
  // 2nd, check if quantity was specified and if it's within 0 and 100
  if (!args) {
    return msg.reply(["Please specify the amount of messages to purge.", "You didn’t specify how many messages to delete.", "How many messages do you want me to delete?"].choose());
  }
  amount = parseInt(args);
  if (!((1 <= amount && amount <= 100))) {
    return msg.reply(["The amount specified must be a positive integer less than 100.", "The amount of messages to delete must be a number greater than 0 and less than or equal to 100."].choose());
  }
  return msg.channel.fetchMessages({
    limit: amount
  }).then(function(msgs) {
    return msg.channel.bulkDelete(msgs);
  }).then(function() {
    return msg.channel.send([`${msg.author}, I deleted ${amount} messages.`, `${msg.author}, Deleted ${amount} messages successfully.`, `Purged ${amount} messages as requested by ${msg.author}`].choose());
  }).catch(function(err) {
    return msg.channel.send(`Failed to delete messages: \n\`\`\`\n${err}\n\`\`\``);
  });
};

module.exports = {
  name: "Purge",
  regex: /^(purge|delete)(\s+|$)/i,
  handler: handler,
  help: {
    short: "-h purge <n>   :: Deletes messages in bulk.",
    long: `\`\`\`asciidoc
=== Help for Purge ===
*Aliases*: purge, delete
-h purge <amount> :: Deletes specified amount of messages in that channel.
*Note:* Both you and I must have permission to delete messages.
\`\`\``
  }
};
