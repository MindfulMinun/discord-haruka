// Generated by CoffeeScript 2.3.1
//! ========================================
//! Edits
var Embed, genEmbed, handler;

Embed = (require('discord.js')).RichEmbed;

genEmbed = function(prev) {
  var edit, edits, embed, i, len, ref, time;
  edits = prev.edits.reverse();
  embed = new Embed().setColor('#448aff').setAuthor(prev.author.tag, prev.author.displayAvatarURL);
  for (i = 0, len = edits.length; i < len; i++) {
    edit = edits[i];
    time = (ref = edit.editedAt) != null ? ref : edit.createdAt;
    time = time.toISOString().slice(0, 19).replace('T', ' ') + ' UTC';
    embed.addField(time, edit.content);
  }
  return embed;
};

handler = function(msg, match, Haruka) {
  var args, ch, chId, gldId, guild, msgId, ref, ref1;
  args = match.input.tokenize()[1];
  console.log(args);
  [msgId, chId, gldId] = (ref = args != null ? (ref1 = args.match(/(\d{18})/g)) != null ? ref1.reverse() : void 0 : void 0) != null ? ref : [null, null, null];
  console.log({msgId, chId, gldId});
  if (!msgId) {
    return msg.reply(["Give me a message ID and I'll reveal its previous edits.", "This function reveals a message's previous edits given its ID."].choose() + " Use `-h help edits` for help on getting a message ID.");
  }
  guild = Haruka.client.guilds.get(gldId || (msg != null ? msg.guild.id : void 0)) || msg.guild;
  ch = (guild != null ? guild.channels.get(chId) : void 0) || msg.channel;
  return ch.fetchMessage(msgId).then(function(prev) {
    var embed;
    embed = genEmbed(prev);
    return msg.reply(`${prev.author.tag}â€™s previous edits: `, embed);
  });
};

module.exports = {
  name: "Edits",
  regex: /^(edits|edit)(\s+|$)/i,
  handler: handler,
  help: {
    short: "-h edits <id>  :: Lists a message's previous edits. Expose your friends.",
    long: "```asciidoc\n=== Help for Edits ===\n*Aliases*: edit, edits\n\n-h edits <something> :: Lists a message's previous edits\n                        from oldest to newest.\n\nBut what is <something>?\n\nIf you're a normie (this is the easiest way to do it):\n    -h edits <url>\n        where <url> is that message's URL (Hover over message ->\n        Click triple dots -> Copy URL)\n\nIf you have developer mode on:\n    -h edits <messageID>\n        This syntax assumes you execute the command in the\n        same *channel* and *guild* it was sent.\n    -h edits <channelID> <messageID>\n        This syntax assumes you execute the command in the\n        same *server* it was sent but not necessarily the\n        same channel.\n    -h edits <guildID> <channelID> <messageID>\n        This lets you execute it anywhere as long as Haruka can\n        read messages from that server.\n\nOh, and you can get all of these IDs by right-clicking on the server\nicon, the server channel, and the message respectively. Be sure not\nto copy the user's ID instead of the message's.\n```"
  }
};
