// Generated by CoffeeScript 2.5.1
//! ========================================
//! xkcd
var Discord, handler, latest, r, randomComicNumber, request;

Discord = require('discord.js');

request = require('request');

r = function(options) {
  return new Promise(function(resolve, reject) {
    return request(options, function(err, response, body) {
      var ref, shouldResolve;
      shouldResolve = [!err, (200 <= (ref = response != null ? response.statusCode : void 0) && ref < 400)].every(function(v) {
        return v;
      }) === true;
      if (shouldResolve) {
        return resolve(JSON.parse(body));
      } else {
        return reject(response);
      }
    });
  });
};

randomComicNumber = function() {
  var temp;
  temp = Math.floor(Math.random() * (latest + 1));
  if ((temp === 404) || (temp === 0)) {
    return randomComicNumber();
  } else {
    return temp;
  }
};

// Get the latest comic once, since Haruka sometimes restarts on her own.
latest = 2138;

(async function() {
  return latest = ((await r('https://xkcd.com/info.0.json'))).num;
})();

handler = function(msg, match, Haruka) {
  var arg, ref, url;
  arg = (ref = match.input.tokenize()[1]) != null ? ref : '';
  console.log(arg);
  url = 'https://xkcd.com/';
  switch (arg) {
    case "random":
      url += randomComicNumber() + '/';
      break;
    case "":
      msg.channel.send('Latest comic:');
      break;
    default:
      url += arg + '/';
  }
  url += 'info.0.json';
  console.log(url);
  return r(url).then(function(comic) {
    var embed;
    embed = new Discord.RichEmbed().setColor('#448aff').setURL(`https://xkcd.com/${comic.num}`).setTitle(comic.title).setImage(comic.img).setFooter(`${comic.month}/${comic.day}/${comic.year}`);
    if (comic.alt != null) {
      embed.setDescription(comic.alt);
    }
    // embed.addField('Transcript', comic.transcript) if comic.transcript?
    return msg.channel.send(embed);
  }).catch(function(err) {
    return msg.reply(["I couldn't fetch that comic. Sorry.", "An error occurred while fetching that comic."].choose());
  });
};

module.exports = {
  name: "xkcd",
  regex: /^(xkcd)(\s+|$)/i,
  handler: handler,
  help: {
    short: "-h xkcd [n]    :: Fetches an xkcd comic.",
    long: `\`\`\`asciidoc
=== Help for xkcd ===
*Aliases*: xkcd
-h xkcd         :: Fetches the most recent xkcd comic
-h xkcd [n]     :: Fetches the nth xkcd comic
-h xkcd random  :: Fetches a random xkcd comic
\`\`\``
  }
};
